{% extends "base.html" %}
{% load static %}

{% block title %}AgroSoft - Dashboard Principal{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        position: relative;
        height: 400px;
        width: 100%;
        margin: 20px 0;
    }
    
    .chart-hover-message {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 20;
        max-width: 250px;
        display: none;
        font-size: 0.9rem;
        color: #495057;
    }
    
    .chart-container:hover .chart-hover-message {
        display: block;
    }
    
    .card {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
        border-radius: 8px;
    }
    
        .card-header {
            background: linear-gradient(135deg, #4CAF50, #66BB6A, #A5D6A7);
            color: white;
            border-radius: 8px 8px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4CAF50, #66BB6A, #A5D6A7);
            border: none;
            border-radius: 6px;
            font-weight: 500;
        }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .form-select {
        border-radius: 6px;
        border: 2px solid #e9ecef;
        transition: border-color 0.3s ease;
    }
    
    .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .alert {
        border-radius: 8px;
        border: none;
    }
    
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 8px;
    }
    
    .spinner-border {
        color: #667eea;
    }
    
    h2 {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 30px;
    }
    
    .lead {
        color: #6c757d;
        font-size: 1.1rem;
    }
</style>
{% endblock %}

{% block content %}
    <div class="container" style="max-width: 1200px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px #0001;">
        <h2>Bienvenido de vuelta, {{ user.username }}</h2>

<!-- Filtros de Municipio -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5>Filtrar por Municipio</h5>
            </div>
            <div class="card-body">
                <form id="filtrosForm" class="row g-3">
                    <div class="col-md-4">
                        <label for="municipio" class="form-label">Municipio</label>
                        <select class="form-select" id="municipio" name="municipio">
                            <option value="">Todos los municipios</option>
                            <option value="Facatativ치">Facatativ치</option>
                            <option value="Madrid">Madrid</option>
                            <option value="Mosquera">Mosquera</option>
                            <option value="El Rosal">El Rosal</option>
                            <option value="Subachoque">Subachoque</option>
                            <option value="Bojac치">Bojac치</option>
                            <option value="Funza">Funza</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-filter"></i> Aplicar Filtros
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

        <!-- Gr치ficos en columnas -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-bar"></i> Rentabilidad de Productos Recomendados</h5>
                        <small class="text-light">Productos con mayor potencial de rentabilidad seg칰n an치lisis de mercado</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="reportesSemanalesChart"></canvas>
                            <div class="chart-hover-message">
                                <strong>游늳 Informaci칩n:</strong><br>
                                Esta gr치fica muestra la evoluci칩n de la cantidad de productos disponibles en el mercado por semana. Ayuda a identificar tendencias de oferta.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Precios Promedio por Producto</h5>
                        <small class="text-light">Evoluci칩n de precios en el mercado para productos recomendados</small>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="tendenciasChart"></canvas>
                            <div class="chart-hover-message">
                                <strong>游눯 Informaci칩n:</strong><br>
                                Esta gr치fica muestra la evoluci칩n de los precios promedio en el mercado por semana. Ayuda a identificar tendencias de precios y oportunidades de compra/venta.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <p class="lead">Estamos contentos de tenerte de vuelta en AgroSoft</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        let reportesChart = null;
        let tendenciasChart = null;

                // Initialize the weekly reports chart - GR츼FICA LINEAL SEMANAL
                function initializeReportesSemanalesChart() {
                    const ctx = document.getElementById('reportesSemanalesChart').getContext('2d');
                    reportesChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [], // Semanas (eje X)
                            datasets: [{
                                label: 'Gr치ficos de Tendencias Simples',
                                data: [], // Cantidad de productos por semana (eje Y)
                                borderColor: 'rgba(75, 192, 192, 1)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                fill: false, // Cambiar a false para gr치ficas lineales
                                tension: 0.1, // Ajustar la tensi칩n para l칤neas m치s rectas
                                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2,
                                pointRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Productos'
                                    },
                                    grid: {
                                        display: true,
                                        color: 'rgba(0,0,0,0.1)'
                                    }
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: 'Cantidad de Productos'
                                    },
                                    beginAtZero: true,
                                    grid: {
                                        display: true,
                                        color: 'rgba(0,0,0,0.1)'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            return `Producto: ${context[0].label}`;
                                        },
                                        label: function(context) {
                                            return `Cantidad de Productos: ${context.parsed.y}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

        // Initialize the trends chart - GR츼FICA LINEAL DE PRECIOS POR SEMANA
        function initializeTendenciasChart() {
            const ctx = document.getElementById('tendenciasChart').getContext('2d');
            tendenciasChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [], // Semanas (eje X)
                    datasets: [{
                        label: 'Precios Promedio',
                        data: [], // Precios promedio por semana (eje Y)
                        borderColor: 'rgba(255, 99, 132, 1)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        fill: false, // Cambiar a false para gr치ficas lineales
                        tension: 0.1, // Ajustar la tensi칩n para l칤neas m치s rectas
                        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Semanas'
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Precio Promedio ($)'
                            },
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(0,0,0,0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            return `Semana: ${context[0].label}`;
                                        },
                                        label: function(context) {
                                            return `Precio Promedio: $${context.parsed.y}`;
                                        }
                                    }
                                }
                    }
                }
            });
        }

        // Load chart data from API
        async function cargarDatosGraficas(municipio = '') {
            try {
                // Show loading state
                document.querySelector('#reportesSemanalesChart').style.opacity = '0.5';
                document.querySelector('#tendenciasChart').style.opacity = '0.5';

                // Fetch data from graficas API
                const url = `/graficas/api/graficas/datos/${municipio ? `?municipio=${encodeURIComponent(municipio)}` : ''}`;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos recibidos:', data);

                // Update reports chart with tendencias data (semanas vs cantidad de productos)
                if (data.tendencias && data.tendencias.semanas && data.tendencias.cantidad_productos) {
                    reportesChart.data.labels = data.tendencias.semanas;
                    reportesChart.data.datasets[0].data = data.tendencias.cantidad_productos;
                    reportesChart.data.datasets[0].label = `Tendencias Simples - ${data.tendencias.municipio}`;
                    reportesChart.update();
                }

                // Update trends chart with price evolution (semanas vs precios promedio)
                if (data.tendencias && data.tendencias.semanas && data.tendencias.precios_promedio) {
                    tendenciasChart.data.labels = data.tendencias.semanas;
                    tendenciasChart.data.datasets[0].data = data.tendencias.precios_promedio;
                    tendenciasChart.data.datasets[0].label = `Precios Promedio - ${data.tendencias.municipio}`;
                    tendenciasChart.update();
                }

                // Load recommendations data
                await cargarDatosRecomendaciones(municipio);

            } catch (error) {
                console.error('Error cargando datos de gr치ficas:', error);
                
                // Show error message
                const errorMsg = document.createElement('div');
                errorMsg.className = 'alert alert-warning mt-3';
                errorMsg.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    Error cargando datos de gr치ficas. Mostrando datos de ejemplo.
                `;
                document.querySelector('.container').appendChild(errorMsg);
                
                // Load sample data
                cargarDatosMuestra();
            } finally {
                // Remove loading state
                document.querySelector('#reportesSemanalesChart').style.opacity = '1';
                document.querySelector('#tendenciasChart').style.opacity = '1';
            }
        }

        // Load recommendations data
        async function cargarDatosRecomendaciones(municipio = '') {
            try {
                const url = `/graficas/api/graficas/recomendaciones/${municipio ? `?municipio=${encodeURIComponent(municipio)}` : ''}`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Datos de recomendaciones:', data);
                    
                    // Update charts with recommendations data if available
                    if (data.recomendaciones && data.recomendaciones.length > 0) {
                        const recomendaciones = data.recomendaciones.slice(0, 8);
                        const labels = recomendaciones.map(r => r.producto.substring(0, 15) + (r.producto.length > 15 ? '...' : ''));
                        const rentabilidades = recomendaciones.map(r => r.rentabilidad_estimada);

                        reportesChart.data.labels = labels;
                        reportesChart.data.datasets[0].data = rentabilidades;
                        reportesChart.update();
                    }
                }
            } catch (error) {
                console.error('Error cargando recomendaciones:', error);
            }
        }

        // Load sample data as fallback - DATOS SEMANALES LINEALES
        function cargarDatosMuestra() {
            // Sample data for reports chart - Gr치ficos de tendencias simples por semana
            const semanas = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4', 'Sem 5', 'Sem 6'];
            const cantidadProductos = [8, 12, 10, 15, 18, 20]; // Cantidad de productos por semana

            reportesChart.data.labels = semanas;
            reportesChart.data.datasets[0].data = cantidadProductos;
            reportesChart.data.datasets[0].label = 'Tendencias Simples - Datos de Muestra';
            reportesChart.update();

            // Sample data for trends chart - Precios promedio por semana
            const preciosPromedio = [1500, 1800, 1600, 2000, 2200, 2100]; // Precios promedio por semana

            tendenciasChart.data.labels = semanas;
            tendenciasChart.data.datasets[0].data = preciosPromedio;
            tendenciasChart.data.datasets[0].label = 'Precios Promedio - Datos de Muestra';
            tendenciasChart.update();
        }

        // Handle filter form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts
            initializeReportesSemanalesChart();
            initializeTendenciasChart();
            
            // Load initial data
            cargarDatosGraficas();

            // Handle filter form
            const filtrosForm = document.getElementById('filtrosForm');
            if (filtrosForm) {
                filtrosForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const municipio = document.getElementById('municipio').value;
                    cargarDatosGraficas(municipio);
                });
            }

            // Auto-refresh data every 5 minutes
            setInterval(() => {
                const municipio = document.getElementById('municipio').value;
                cargarDatosGraficas(municipio);
            }, 300000); // 5 minutes
        });
    </script>
{% endblock %}
