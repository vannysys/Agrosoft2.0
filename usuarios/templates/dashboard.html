{% extends "base.html" %}
{% load static %}

{% block title %}AgroSoft - Dashboard Principal{% endblock %}

{% block content %}
    <!-- Contenido para usuarios autenticados -->
    <div class="container" style="max-width: 1200px; margin: 40px auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 8px #0001;">
        <h2>Bienvenido de vuelta, {{ user.username }}</h2>
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-success">{{ message }}</div>
            {% endfor %}
        {% endif %}
        
        <p class="lead">Estamos contentos de tenerte de vuelta en AgroSoft</p>

        <!-- Gráficos de producción -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Producción por Cultivo</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="produccionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Precio del Mercado - Algodón</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="algodonChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico de viabilidad -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Viabilidad de Cultivos</h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="viabilidadChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Estadísticas Generales</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <h6>Total de Cultivos</h6>
                                <p class="h4 text-primary">125</p>
                            </div>
                            <div class="col-6">
                                <h6>Ingresos Totales</h6>
                                <p class="h4 text-success">$145,000</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {% if user.tipo == 'agricultor' %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5>Mis Solicitudes Recientes</h5>
                </div>
                <div class="card-body">
                    {% if solicitudes_recientes %}
                        <ul class="list-group">
                            {% for solicitud in solicitudes_recientes %}
                                <li class="list-group-item">
                                    <strong>{{ solicitud.cultivo_deseado }}</strong> - 
                                    {{ solicitud.fecha|date:"d/m/Y" }} - 
                                    <span class="badge bg-{% if solicitud.estado == 'procesada' %}success{% else %}warning{% endif %}">
                                        {{ solicitud.estado }}
                                    </span>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No tienes solicitudes recientes.</p>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </div>

    <script>
    // Función para obtener datos en tiempo real
    async function actualizarDatosDashboard() {
        try {
            const response = await fetch('/api/dashboard-data/');
            const data = await response.json();
            
            actualizarGraficos(data);
            
            // Actualizar cada 30 segundos
            setTimeout(actualizarDatosDashboard, 30000);
        } catch (error) {
            console.error('Error al actualizar datos:', error);
            // Reintentar después de 60 segundos en caso de error
            setTimeout(actualizarDatosDashboard, 60000);
        }
    }

    function actualizarGraficos(data) {
        // Gráfico de producción por cultivo
        if (data.produccionPorCultivo && data.produccionPorCultivo.labels.length > 0) {
            const ctx = document.getElementById('produccionChart').getContext('2d');
            if (window.produccionChart) {
                window.produccionChart.destroy();
            }
            window.produccionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.produccionPorCultivo.labels,
                    datasets: [{
                        label: 'Producción (kg)',
                        data: data.produccionPorCultivo.data,
                        borderColor: '#FF6384',
                        fill: false,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad (kg)'
                            }
                        }
                    }
                }
            });
        }

        // Gráfico de viabilidad
        if (data.viabilidadData && data.viabilidadData.labels.length > 0) {
            const ctx3 = document.getElementById('viabilidadChart').getContext('2d');
            if (window.viabilidadChart) {
                window.viabilidadChart.destroy();
            }
            window.viabilidadChart = new Chart(ctx3, {
                type: 'pie',
                data: {
                    labels: data.viabilidadData.labels,
                    datasets: [{
                        data: data.viabilidadData.data,
                        backgroundColor: [
                            '#4BC0C0', '#FFCE56', '#FF6384', '#36A2EB', '#9966FF'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
    }

    // Inicializar gráficos con datos estáticos iniciales
    document.addEventListener('DOMContentLoaded', function() {
        // Datos iniciales (pueden ser reemplazados por la API)
        const datosIniciales = {
            produccionPorCultivo: {
                labels: ['Maíz', 'Frijol', 'Arroz'],
                data: [500, 300, 200]
            },
            viabilidadData: {
                labels: ['Alta', 'Media', 'Baja'],
                data: [60, 30, 10]
            }
        };
        
        actualizarGraficos(datosIniciales);
        
        // Iniciar actualización automática
        actualizarDatosDashboard();
    });
    </script>
{% endblock %}
